// DCT Event Management Platform - Database Schema
// This schema supports the dual-sided marketplace for customers and vendors

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

// ============================================
// USER MANAGEMENT
// ============================================

enum UserRole {
  CUSTOMER
  VENDOR
  ADMIN
}

enum ProfileType {
  INDIVIDUAL
  COMPANY
}

model User {
  id            String      @id @default(uuid())
  email         String      @unique
  passwordHash  String
  role          UserRole    @default(CUSTOMER)
  profileType   ProfileType @default(INDIVIDUAL)
  firstName     String?
  lastName      String?
  phone         String?
  avatar        String?
  isVerified    Boolean     @default(false)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // Relations
  customer      Customer?
  vendor        Vendor?
  messages      Message[]
  notifications Notification[]

  @@index([email])
  @@index([role])
}

// ============================================
// CUSTOMER PROFILE
// ============================================

model Customer {
  id        String   @id @default(uuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  events   Event[]
  rfps     RFP[]
  bookings Booking[]
  reviews  Review[]

  @@index([userId])
}

// ============================================
// VENDOR PROFILE
// ============================================

enum VendorCategory {
  PHOTOGRAPHER
  VENUE
  CATERING
  MUSIC_ENTERTAINMENT
  FLORAL_DECOR
  VIDEOGRAPHY
  DJ
  BAND
  CAKE
  MAKEUP
  PLANNING
  OTHER
}

enum SubscriptionPlan {
  FREE_TRIAL
  BASIC
  PREMIUM
  ENTERPRISE
}

model Vendor {
  id               String           @id @default(uuid())
  userId           String           @unique
  user             User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  businessName     String
  category         VendorCategory
  description      String?
  rating           Float            @default(5.0)
  totalBookings    Int              @default(0)
  totalEarnings    Float            @default(0)
  commissionRate   Float            @default(0.10) // 10% default
  subscriptionPlan SubscriptionPlan @default(FREE_TRIAL)
  subscriptionEnds DateTime?
  nextPayoutDate   DateTime?
  isActive         Boolean          @default(true)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  // Business Details
  address          String?
  city             String?
  state            String?
  zipCode          String?
  website          String?
  instagram        String?
  facebook         String?

  // Pricing
  priceMin         Float?
  priceMax         Float?

  // Relations
  portfolio        VendorPortfolio[]
  quotes           Quote[]
  bookings         Booking[]
  reviews          Review[]
  availability     VendorAvailability[]

  @@index([userId])
  @@index([category])
  @@index([rating])
  @@index([city])
}

model VendorPortfolio {
  id          String   @id @default(uuid())
  vendorId    String
  vendor      Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  imageUrl    String
  title       String?
  description String?
  order       Int      @default(0)
  createdAt   DateTime @default(now())

  @@index([vendorId])
}

model VendorAvailability {
  id        String   @id @default(uuid())
  vendorId  String
  vendor    Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  date      DateTime
  isBooked  Boolean  @default(false)
  createdAt DateTime @default(now())

  @@unique([vendorId, date])
  @@index([vendorId])
  @@index([date])
}

// ============================================
// EVENT MANAGEMENT
// ============================================

enum EventType {
  WEDDING
  CORPORATE
  BIRTHDAY
  BABY_SHOWER
  REUNION
  PARTY
  OTHER
}

enum EventStyle {
  CLASSIC_ELEGANCE
  MODERN_CHIC
  RUSTIC_CHARM
  BOHEMIAN
  MINIMALIST
  TRADITIONAL
  OTHER
}

enum VenuePreference {
  INDOOR
  OUTDOOR
  BOTH
}

enum EventStatus {
  PLANNING
  CONFIRMED
  COMPLETED
  CANCELLED
}

model Event {
  id               String           @id @default(uuid())
  customerId       String
  customer         Customer         @relation(fields: [customerId], references: [id], onDelete: Cascade)
  name             String
  type             EventType
  date             DateTime?
  guestCount       Int              @default(100)
  location         String?
  city             String?
  venuePreference  VenuePreference  @default(BOTH)
  stylePreference  EventStyle?
  budgetMin        Float            @default(5000)
  budgetMax        Float            @default(20000)
  budgetSpent      Float            @default(0)
  status           EventStatus      @default(PLANNING)
  notes            String?          
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  // Relations
  rfps             RFP[]
  bookings         Booking[]
  timeline         EventTimeline[]
  servicesNeeded   EventService[]
  expenses         Expense[]

  @@index([customerId])
  @@index([type])
  @@index([date])
  @@index([status])
}

model Expense {
  id        String   @id @default(uuid())
  eventId   String
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  category  String
  allocated Float    @default(0)
  spent     Float    @default(0)
  status    String   @default("Pending") // Under, Over, Pending
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([eventId])
}

model EventService {
  id        String   @id @default(uuid())
  eventId   String
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  service   String // venue, photographer, catering, etc.
  isBooked  Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([eventId])
}

model EventTimeline {
  id          String   @id @default(uuid())
  eventId     String
  event       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  title       String
  description String?  
  dueDate     DateTime
  isCompleted Boolean  @default(false)
  createdAt   DateTime @default(now())

  @@index([eventId])
  @@index([dueDate])
}

// ============================================
// RFP (REQUEST FOR PROPOSAL) SYSTEM
// ============================================

enum RFPStatus {
  OPEN
  QUOTED
  ACCEPTED
  REJECTED
  EXPIRED
}

model RFP {
  id                String       @id @default(uuid())
  eventId           String
  event             Event        @relation(fields: [eventId], references: [id], onDelete: Cascade)
  customerId        String
  customer          Customer     @relation(fields: [customerId], references: [id], onDelete: Cascade)
  leadType          EventType
  budgetMin         Float
  budgetMax         Float
  deadline          DateTime?
  status            RFPStatus    @default(OPEN)
  
  // Specific Requirements
  cateringType      String?
  seatingStyle      String?
  dietaryReqs       String?      
  stylePreferences  String?      
  referenceImages   String?      // JSON array of image URLs
  additionalNotes   String?      
  
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  // Relations
  quotes            Quote[]

  @@index([customerId])
  @@index([eventId])
  @@index([status])
  @@index([deadline])
}

// ============================================
// QUOTE MANAGEMENT
// ============================================

enum QuoteStatus {
  PENDING
  ACCEPTED
  REJECTED
  EXPIRED
}

model Quote {
  id          String      @id @default(uuid())
  rfpId       String
  rfp         RFP         @relation(fields: [rfpId], references: [id], onDelete: Cascade)
  vendorId    String
  vendor      Vendor      @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  amount      Float
  description String      
  status      QuoteStatus @default(PENDING)
  validUntil  DateTime
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  booking     Booking?

  @@index([rfpId])
  @@index([vendorId])
  @@index([status])
}

// ============================================
// BOOKING & PAYMENT
// ============================================

enum BookingStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

model Booking {
  id            String        @id @default(uuid())
  eventId       String
  event         Event         @relation(fields: [eventId], references: [id], onDelete: Cascade)
  customerId    String
  customer      Customer      @relation(fields: [customerId], references: [id], onDelete: Cascade)
  vendorId      String
  vendor        Vendor        @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  quoteId       String        @unique
  quote         Quote         @relation(fields: [quoteId], references: [id])
  amount        Float
  status        BookingStatus @default(PENDING)
  paymentStatus PaymentStatus @default(PENDING)
  bookingDate   DateTime      @default(now())
  serviceDate   DateTime
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  payments      Payment[]
  review        Review?

  @@index([eventId])
  @@index([customerId])
  @@index([vendorId])
  @@index([status])
}

model Payment {
  id              String        @id @default(uuid())
  bookingId       String
  booking         Booking       @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  amount          Float
  status          PaymentStatus @default(PENDING)
  stripePaymentId String?       @unique
  paidAt          DateTime?
  createdAt       DateTime      @default(now())

  @@index([bookingId])
  @@index([status])
}

// ============================================
// REVIEW SYSTEM
// ============================================

model Review {
  id         String   @id @default(uuid())
  bookingId  String   @unique
  booking    Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  vendorId   String
  vendor     Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  rating     Float // 1-5
  comment    String?  
  createdAt  DateTime @default(now())

  @@index([vendorId])
  @@index([rating])
}

// ============================================
// MESSAGING SYSTEM
// ============================================

model Message {
  id         String   @id @default(uuid())
  senderId   String
  sender     User     @relation(fields: [senderId], references: [id], onDelete: Cascade)
  receiverId String
  content    String   
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())

  @@index([senderId])
  @@index([receiverId])
  @@index([createdAt])
}

// ============================================
// NOTIFICATIONS
// ============================================

enum NotificationType {
  NEW_RFP
  NEW_QUOTE
  BOOKING_CONFIRMED
  PAYMENT_RECEIVED
  REVIEW_RECEIVED
  MESSAGE_RECEIVED
  REMINDER
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      NotificationType
  title     String
  message   String           
  isRead    Boolean          @default(false)
  link      String?
  createdAt DateTime         @default(now())

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}
// ============================================
// SYSTEM & CONFIGURATION
// ============================================

model SubscriptionPackage {
  id          String   @id @default(uuid())
  name        String
  price       Float
  target      String   // CUSTOMER or VENDOR
  features    String   // Comma separated or JSON
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ContentItem {
  id          String   @id @default(uuid())
  title       String
  slug        String   @unique
  content     String
  category    String   // BLOG, FAQ, HELP, LEGAL
  status      String   @default("DRAFT") // DRAFT, PUBLISHED
  author      String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model PlatformSetting {
  key         String   @id
  value       String   
  updatedAt   DateTime @updatedAt
}
